---
title: "Video and Image Processing"
output: rmarkdown::html_vignette
params:
  EVAL: !r identical(Sys.getenv("NOT_CRAN"), "true")
vignette: >
  %\VignetteIndexEntry{Video and Image Processing}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## User input

The image analysis functions `kin.search()`, `kin.simple()`, and `kin.free()` (i.e., the `kin` functions) require image sequences stored in a directory. The argument `img.dir` specifies which directory contains the images to be analyzed. Supported image formats include jpeg, png, and tiff.

Users can start analysis with images extracted from videos using some other software program (e.g., imageJ). However, they must be given unique file names that end in a sequence number. For example "image_01.jpeg", "image_02.jpeg", etc.

If the starting point of analysis is a video file, `trackter`'s `video.to.images()` or `video.to.images2()` can be used to extract images to a user-defined directory. Supported video formats include .avi and .mp4 files. For example, the following with extract images from an 11-frame video of a swimming pumpkinseed sunfish included with the package. 

```{r,message=FALSE,warning=FALSE}
library(trackter)
sunfish.vid <- system.file("extdata/vid", "sunfish_BCF_red.avi", package = "trackter")
dir.create("./sunfish_images")
vid.to.images(vid.path = sunfish.vid, out.dir = "./sunfish_images")

```

The 11 files are now in the "./sunfish_images" directory and the first one is displayed

```{r}
list.files("./sunfish_images")

EBImage::display(EBImage::readImage(list.files("./sunfish_images",full.names = TRUE)[1]),method = "raster")
```
## Filter extracted images

`video.to.images2()` supports added `FFmpeg` functionality, allowing users to specify filters that may, for example crop, rotate, or adjust the size of the images. Filters can be passed to the `filt` argument as a character string.  For example, one can extract images from the same video and crop around their center at 900 pixels wide and 400 pixels deep with the following.

```{r}
#Crop the central input area with size 900x300:
filt.crop <- ' -vf crop=900:300 '
#creat the directory again

#will overwrite images in the directory
vid.to.images2(vid.path = sunfish.vid, out.dir = "./sunfish_images", filt = filt.crop,silent = ) # extract
```

Now, display one of the cropped images.

```{r}
EBImage::display(EBImage::readImage(list.files("./sunfish_images",full.names = TRUE)[1]),method = "raster")
```

Notice that the character string passed to `filt` begins and ends with a white space and the first part of the string contains " -vf" which implements a video filter in `FFmpeg`. To learn more about filters, users can check out the [`FFmpeg` wiki site](https://ffmpeg.org/ffmpeg-filters.html).

Here's another example with a filter that doubles the contrast.

```{r}
#boost the contrast
filt.br <- ' -vf "eq=contrast=2" '

#extract and filter (overwriting the previous extraction)
vid.to.images2(vid.path = sunfish.vid, out.dir = "./sunfish_images", filt = filt.br) 

#display
EBImage::display(EBImage::readImage(list.files("./sunfish_images",full.names = TRUE)[1]),method = "raster")

#clean up
#unlink("./sunfish_images",recursive = TRUE)
```

For those who simply want to crop images or change their contrast without using `FFmpeg` filters, `trackter` offers `crop.img()` and `contrast.img()`, respectively. Continuing with the same image sequence, `crop.img()` is used here to crop the images with a rectangle described the arguments `ul` (the lower left xy position) and `br` (the bottom right xy position) and save them the a directory specified by `out.dir`.

```{r}
#create the out.dir
dir.create("./sunfish_images2")

#crop at pixels 5,150 and 900,400
crop.img(img="./sunfish_images",out.dir ="./sunfish_images2",ul=c(5,150),br=c(900,400))

#display the first cropped image in the sequence
EBImage::display(EBImage::readImage("./sunfish_images2/sunfish_BCF_red_00001.jpg"),method="raster")

```

Here, the same image sequence has its contrast enhanced with `contrast.img()`. Contrast is doubled in this case with the argument `c=2`.

```{r}
#contrast and overwrite imgages in out.dir
contrast.img(img="./sunfish_images",out.dir ="./sunfish_images2",c=2)

#display the first cropped image in the sequence
EBImage::display(EBImage::readImage("./sunfish_images2/sunfish_BCF_red_00001.jpg"),method="raster")

```
